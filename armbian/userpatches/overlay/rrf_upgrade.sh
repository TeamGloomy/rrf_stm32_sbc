#!/bin/bash
VERSION="0.0.9"

SCRIPT_URL="https://raw.githubusercontent.com/TeamGloomy/rrf_stm32_sbc/master/armbian/userpatches/overlay/rrf_upgrade.sh"
SCRIPT_LOCATION="${BASH_SOURCE[@]}"
SELF_UPDATER_SCRIPT=/tmp/rrf_selfupdater.sh

SRC="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
DSF_CONF=/opt/dsf/conf/config.json

FW_DOWNLOAD_TEMP_DIR="/tmp/teamgloomy_fw_temp"

if [ $# -lt 1 ]; then
    echo "Usage: rrf_upgrade <RRF_version>. Example: rrf_upgrade 3.4-b7 or rrf_upgrade latest-stable or rrf_upgrade latest-unstable"
    exit 1
fi

if [ "${EUID}" -ne "0" ]; then
    echo "This script requires root privileges, trying to use sudo"
    sudo "$0" "$@"
    exit $?
fi

RRF_VERSION="$1"

main()
{
    echo "-----This will install the Duet packages for ${RRF_VERSION} -----"
#    echo "-----Update and upgrade the SBC system-----"
    hold_packages
#    apt-get -q update && apt-get -y upgrade
#    echo "-----Upgrade and Update finished-----"
    add_duet_repo
    echo "-----Updating packages list-----"
    apt-get -q update
    echo "-----Updating packages finished-----"
    echo "-----Downloading TeamGloomy firmware-----"
    get_teamgloomy_fw
    echo "-----Downloading TeamGloomy firmware finished-----"
    # Backup the config file prior to mess with
    backup_board_conf
    stop_rrf_services
    echo "-----Installing packages-----"
    unhold_packages
    install_packages
    hold_packages
    echo "-----Installing packages finished-----"
    restore_board_conf
    restart_rrf_services
}

backup_board_conf()
{
    echo "-----Backup board configuration-----"
    # Check if configuration has been changed since installation
    INSTALLED_CONF_CHECKSUM=$(cat /var/lib/dpkg/info/duetcontrolserver.md5sums | grep opt/dsf/conf/config.json | awk 'NR==1{print $1}')
    CUR_CONF_CHECKSUM=$(md5sum /opt/dsf/conf/config.json | awk 'NR==1{print $1}')
    DCS_CONF_CHANGED_BY_USER=0; [ "$CUR_CONF_CHECKSUM" != "$INSTALLED_CONF_CHECKSUM" ] && DCS_CONF_CHANGED_BY_USER=1

    cp "$DSF_CONF" "$DSF_CONF.bak"
    SPI_DEVICE="$(grep "^\s\+\"SpiDevice" $DSF_CONF | awk -F': "' '{print $2}')"
    GPIO_CHIP_DEVICE="$(grep "^\s\+\"GpioChipDevice" $DSF_CONF | awk -F': "' '{print $2}')"
    TRANSFER_READY_PIN="$(grep "^\s\+\"TransferReadyPin" $DSF_CONF | awk -F': ' '{print $2}')"
    echo "-----Backup board configuration finished-----"
}

restore_board_conf()
{
    echo "-----Restore board configuration-----"
    sed -i -e 's|"SpiDevice": .*,|"SpiDevice": "'"${SPI_DEVICE}"'|g' "$DSF_CONF"
    sed -i -e 's|"GpioChipDevice": .*,|"GpioChipDevice": "'"${GPIO_CHIP_DEVICE}"'|g' "$DSF_CONF"
    sed -i -e 's|"TransferReadyPin": .*,|"TransferReadyPin": '"${TRANSFER_READY_PIN}"'|g' "$DSF_CONF"

    # Update the package checksum as we could check if the configuration file was modified by the user on the next upgrade
    sed -i -e "s%.*opt/dsf/conf/config.json%$(md5sum /opt/dsf/conf/config.json | awk 'NR==1{print $1}')  opt/dsf/conf/config.json%g" /var/lib/dpkg/info/duetcontrolserver.md5sums
    echo "-----Restore board configuration finished-----"
}

hold_packages()
{
    apt-mark hold \
        duetcontrolserver \
        duetpluginservice \
        duetpimanagementplugin \
        duetruntime \
        duetsd \
        duetsoftwareframework \
        duettools \
        duetwebcontrol \
        duetwebserver \
        reprapfirmware
}

unhold_packages()
{
    apt-mark unhold \
        duetcontrolserver \
        duetpluginservice \
        duetpimanagementplugin \
        duetruntime \
        duetsd \
        duetsoftwareframework \
        duettools \
        duetwebcontrol \
        duetwebserver \
        reprapfirmware
}

add_duet_repo()
{
    if [ ${RRF_VERSION} == "latest-stable" ];
    then
        echo "-----Switching to the stable branch-----"
        wget -q https://pkg.duet3d.com/duet3d.gpg -O /etc/apt/trusted.gpg.d/duet3d.gpg
        wget -q https://pkg.duet3d.com/duet3d.list -O /etc/apt/sources.list.d/duet3d.list
        rm -f /etc/apt/sources.list.d/duet3d-unstable.list
        add_preference_file
        echo "-----Switching to the stable branch finished-----"
    else
        echo "-----Switching to the unstable branch-----"
        wget -q https://pkg.duet3d.com/duet3d.gpg -O /etc/apt/trusted.gpg.d/duet3d.gpg
        wget -q https://pkg.duet3d.com/duet3d-unstable.list -O /etc/apt/sources.list.d/duet3d-unstable.list
        rm -f /etc/apt/sources.list.d/duet3d.list
        add_preference_file
        echo "-----Switching to the unstable branch finished-----"
    fi
}

add_preference_file()
{
    # Set priority higher than 1000 for duet package to allow them to be downgraded
    # even if there is a newer version currently installed on the system
    tee /etc/apt/preferences.d/10-duet-teamgloomy > /dev/null << END
# DO NOT EDIT THIS FILE !
# ANY CHANGE WILL BE OVERWRITTEN BY THE rrf_upgrade SCRIPT
# USE ANOTHER FILE WITH HIGHER PRIORITY INSTEAD e.g 00-duet
Package: *
Pin: origin "pkg.duet3d.com"
Pin-Priority: 1001
END
}

install_packages()
{
    if [ "${RRF_VERSION}" == "latest-stable" ] || [ "${RRF_VERSION}" == "latest-unstable" ];
    then
        apt-get -y install --allow-downgrades -o Dpkg::Options::=--force-confnew \
            duetcontrolserver \
            duetpluginservice \
            duetpimanagementplugin \
            duetruntime \
            duetsd \
            duetsoftwareframework \
            duettools \
            duetwebcontrol \
            duetwebserver \
            reprapfirmware
    else
        apt-get -y install --allow-downgrades -o Dpkg::Options::=--force-confnew \
            duetcontrolserver=${RRF_VERSION} \
            duetpluginservice=${RRF_VERSION} \
            duetpimanagementplugin=${RRF_VERSION} \
            duetruntime=${RRF_VERSION} \
            duetsd=1.1.0 \
            duetsoftwareframework=${RRF_VERSION} \
            duettools=${RRF_VERSION} \
            duetwebcontrol=${RRF_VERSION} \
            duetwebserver=${RRF_VERSION} \
            reprapfirmware=${RRF_VERSION}-1
    fi
}

stop_rrf_services()
{
    echo "-----Stopping Duet services-----"
    # Disable DCS to prevent automatic restart once installed and prior to restore board configuration
    # this way no error will be displayed because of wrong board SPI configuration
    # Check is done in /var/lib/dpkg/info/duetcontrolserver.postinst
    systemctl stop duetcontrolserver
    systemctl disable duetcontrolserver
    echo "-----Stopping Duet services finished-----"
}

restart_rrf_services()
{
    echo "-----Starting Duet services-----"
    systemctl enable duetcontrolserver
    systemctl start duetcontrolserver

    systemctl enable duetpluginservice
    systemctl start duetpluginservice

    systemctl enable duetpluginservice-root
    systemctl start duetpluginservice-root

    /opt/dsf/bin/PluginManager -q reload DuetPiManagementPlugin
    /opt/dsf/bin/PluginManager -q start DuetPiManagementPlugin
    echo "-----Starting Duet services finished-----"
}

install_teamgloomy_fw_files()
{
    for FILE in `find "${FW_DOWNLOAD_TEMP_DIR}" -maxdepth 1 -type f`
    do
        FILENAME=$(basename ${FILE})
        if [[ "$FILENAME" =~ firmware-.*-sbc-.*\.bin ]]
        then
            if [ ${RRF_VERSION} == '3.4.1' ]
            then
                # Rename firmware-mcutype-sbc-version.bin files into firmware-mcutype.bin (Specific to 3.4.1)
                echo "Move ${FW_DOWNLOAD_TEMP_DIR}"/"${FILENAME} to /opt/dsf/sd/firmware/"${FILENAME%-*}.bin""
                mv "${FW_DOWNLOAD_TEMP_DIR}"/"${FILENAME}" /opt/dsf/sd/firmware/"${FILENAME%-*}.bin"
            else
                # Rename firmware-mcutype-sbc-version.bin files into firmware-mcutype-sbc.bin
                echo "Move ${FW_DOWNLOAD_TEMP_DIR}"/"${FILENAME} to /opt/dsf/sd/firmware/"${FILENAME%-*-*}.bin""
                mv "${FW_DOWNLOAD_TEMP_DIR}"/"${FILENAME}" /opt/dsf/sd/firmware/"${FILENAME%-*-*}.bin"
            fi
        else
            echo "Move ${FILE} to /opt/dsf/sd/firmware/"${FILENAME}""
            mv ${FILE} /opt/dsf/sd/firmware/
        fi
    done
}

get_teamgloomy_fw()
{
    if [ "${RRF_VERSION}" == "latest-stable" ] || [ "${RRF_VERSION}" == "latest_stable" ]
    then
        # Get the most recent non-prerelease, non-draft release
        FW_REPO="https://api.github.com/repos/gloomyandy/RepRapFirmware/releases/latest"
        RELEASE_DATA=$(curl -s "${FW_REPO}")
    elif [ "${RRF_VERSION}" == "latest-unstable" ] || [ "${RRF_VERSION}" == "latest_unstable" ]
    then
        # Get the most recent release
        FW_REPO="https://api.github.com/repos/gloomyandy/RepRapFirmware/releases"
        RELEASE_DATA=$(curl -s "${FW_REPO}" | jq '.[0]')
    else
        # Get the release for a specific version
        FW_REPO="https://api.github.com/repos/gloomyandy/RepRapFirmware/releases"
        # Get data related to the last teamgloomy release for the selected Duet version
        RELEASE_DATA=$(curl -s "${FW_REPO}" | jq '.[] | select(.tag_name? | match("v'${RRF_VERSION//\~/-}'(_.*)?"))')
    fi
    # Get SBC related zip files for that release
    # NB: using jq -r to remove quotes for wget to work
    ASSETS_URLS=$(echo -E "${RELEASE_DATA}" | jq -r '.assets[] | select(.name? | match("firmware-.*-sbc-.*.zip"|"STM32RepRapFirmwareSBC.zip")) | .browser_download_url')

    if [ -z ${ASSETS_URLS} ]
    then
        echo -e "\033[0;31mWarning: No teamgloomy firmware found for ${RRF_VERSION}\033[0m"
    else
        mkdir -p "${FW_DOWNLOAD_TEMP_DIR}"
        for url in ${ASSETS_URLS}
        do
            echo "Download TeamGloomy firmware archive from ${url}:"
            wget -q -nc --show-progress "${url}" -O teamgloomy_fw.zip
            unzip -o -d "${FW_DOWNLOAD_TEMP_DIR}" teamgloomy_fw.zip
            rm teamgloomy_fw.zip

            chown "dsf:dsf" "${FW_DOWNLOAD_TEMP_DIR}"/*
            install_teamgloomy_fw_files
        done
        rm -rf "${FW_DOWNLOAD_TEMP_DIR}"
    fi
}

self-update()
{
    # Delete previous self-updater script if any
    rm -f "$SELF_UPDATER_SCRIPT"

    TMP_FILE=$(mktemp -p "" "XXXXX.sh")
    curl -s -L "$SCRIPT_URL" > "$TMP_FILE"
    NEW_VER=$(grep "^VERSION" "$TMP_FILE" | awk -F'[="]' '{print $3}')
    ABS_SCRIPT_PATH=$(readlink -f "$SCRIPT_LOCATION")
    if [ "$VERSION" \< "$NEW_VER" ]
    then
        printf "Updating script \e[31;1m%s\e[0m -> \e[32;1m%s\e[0m\n" "$VERSION" "$NEW_VER"

        echo "cp \"$TMP_FILE\" \"$ABS_SCRIPT_PATH\"" > "$SELF_UPDATER_SCRIPT"
        echo "rm -f \"$TMP_FILE\"" >> "$SELF_UPDATER_SCRIPT"
        echo "echo Running script again: `basename ${BASH_SOURCE[@]}` $@" >> "$SELF_UPDATER_SCRIPT"
        echo "exec \"$ABS_SCRIPT_PATH\" \"$@\"" >> "$SELF_UPDATER_SCRIPT"

        chmod +x "$SELF_UPDATER_SCRIPT"
        chmod +x "$TMP_FILE"
        exec "$SELF_UPDATER_SCRIPT"
    else
        echo "The script is up-to-date. Continue..."
        rm -f "$TMP_FILE"
    fi
}

self-update "$@"
main
